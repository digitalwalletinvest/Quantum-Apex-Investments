<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Account â€“ Quantum Apex</title>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
body{ font-family:Inter,system-ui,sans-serif; background:radial-gradient(circle at top,#1e293b,#020617); }
.card{ background:linear-gradient(180deg,#020617,#020617cc); border:1px solid #1f2937; border-radius:18px; box-shadow:0 20px 40px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.03); }
input,select{ background:#020617; border:1px solid #334155; color:#f9fafb; }
input:focus,select:focus{ outline:none; border-color:#10b981; box-shadow:0 0 0 2px rgba(16,185,129,.15); }
.toast{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#020617; padding:12px 26px; border-radius:14px; box-shadow:0 18px 36px rgba(0,0,0,.7); display:none; font-weight:700; z-index:1000; text-align:center; }
</style>
</head>
<body class="min-h-screen flex items-center justify-center text-white px-3">

<div class="card w-full max-w-sm p-5">
  <div class="text-center mb-4">
    <h1 class="text-xl font-extrabold text-emerald-400">Create Account</h1>
    <p class="text-gray-400 text-xs mt-0.5">Join Quantum Apex and earn up to 40% profit</p>
  </div>
  <div class="space-y-2.5">
    <div>
      <label class="block text-[10px] uppercase text-gray-400 mb-0.5">Full Name</label>
      <input id="name" class="w-full h-9 px-3 rounded-md" placeholder="John Doe">
    </div>
    <div>
      <label class="block text-[10px] uppercase text-gray-400 mb-0.5">Email Address</label>
      <input id="email" type="email" class="w-full h-9 px-3 rounded-md" placeholder="you@email.com">
    </div>
    <div>
      <label class="block text-[10px] uppercase text-gray-400 mb-0.5">Phone Number</label>
      <input id="phone" class="w-full h-9 px-3 rounded-md" placeholder="+254...">
    </div>
    <div>
      <label class="block text-[10px] uppercase text-gray-400 mb-0.5">Country</label>
      <select id="country" class="w-full h-9 px-3 rounded-md">
        <option value="">Select Country</option>
        <option>Kenya</option><option>Uganda</option><option>Tanzania</option>
        <option>Rwanda</option><option>Zambia</option><option>Zimbabwe</option>
        <option>Botswana</option><option>South Africa</option><option>Mozambique</option>
        <option>Ethiopia</option><option>South Sudan</option><option>Nigeria</option>
        <option>France</option><option>United Kingdom</option>
      </select>
    </div>
    <div>
      <label class="block text-[10px] uppercase text-gray-400 mb-0.5">Password</label>
      <input id="password" type="password" class="w-full h-9 px-3 rounded-md">
    </div>
    <div>
      <label class="block text-[10px] uppercase text-gray-400 mb-0.5">Confirm Password</label>
      <input id="confirmPassword" type="password" class="w-full h-9 px-3 rounded-md">
    </div>
    <div>
      <label class="block text-[10px] uppercase text-gray-400 mb-0.5">Referral Code (Optional)</label>
      <input id="referral" class="w-full h-9 px-3 rounded-md" placeholder="QA-XXXX">
    </div>
  </div>
  <button id="registerBtn" class="mt-4 w-full h-10 rounded-lg font-extrabold text-sm
           bg-gradient-to-r from-emerald-500 to-emerald-600
           hover:from-emerald-600 hover:to-emerald-700
           shadow shadow-emerald-500/25 transition">
    Create Account
  </button>
  <p class="text-center mt-3 text-xs text-gray-400">
    Already have an account?
    <a href="login.html" class="text-emerald-400 font-semibold hover:underline">Login</a>
  </p>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// Firebase config
const app = initializeApp({
  apiKey:"AIzaSyDaEphuY2kQue8m-20DDs68JDgQirAycBE",
  authDomain:"digital-wallet-40297.firebaseapp.com",
  databaseURL:"https://digital-wallet-40297-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"digital-wallet-40297"
});
const auth = getAuth(app);
const db = getDatabase(app);
const toast = document.getElementById("toast");

// DOM Elements
const registerBtn = document.getElementById("registerBtn");
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const phoneInput = document.getElementById("phone");
const countrySelect = document.getElementById("country");
const passwordInput = document.getElementById("password");
const confirmPasswordInput = document.getElementById("confirmPassword");
const referralInput = document.getElementById("referral");

// Toast
function showToast(msg, ok=true){
  toast.innerText = msg;
  toast.style.display = "block";
  toast.style.color = ok?"#10b981":"#ef4444";
  setTimeout(()=>toast.style.display="none",3000);
}

// Generate unique referral code
function genCode(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

// Register
registerBtn.onclick = async () => {
  const name = nameInput.value.trim();
  const email = emailInput.value.trim();
  const phone = phoneInput.value.trim();
  const country = countrySelect.value;
  const pass = passwordInput.value;
  const pass2 = confirmPasswordInput.value;
  const refCode = referralInput.value.trim().toUpperCase();

  if(!name||!email||!phone||!country||!pass||!pass2){ showToast("Please complete all required fields",false); return; }
  if(pass!==pass2){ showToast("Passwords do not match",false); return; }

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    const uid = cred.user.uid;
    const myCode = genCode();

    // Validate referral using referralCodes node
    let referredBy = null;
    if(refCode){
      const refSnap = await get(ref(db,"users/referralCodes/"+refCode));
      if(refSnap.exists()){
        referredBy = refSnap.val(); // uid of the referring user
      } else {
        showToast("Referral code invalid", false);
        return;
      }
    }

    // Save new user
    await set(ref(db,"users/"+uid),{
      uid,name,email,phone,country,
      mainBalance:0,lockedBalance:0,referralBalance:0,
      totalDeposited:0,totalProfit:0,totalWithdrawn:0,
      referralCode: myCode,
      referredBy,
      robotPurchased:false,
      createdAt:Date.now()
    });

    // Add referral code mapping for public lookup
    await set(ref(db,"users/referralCodes/"+myCode), uid);

    // Optional: credit referral instantly (can be removed if only on deposit)
    if(referredBy){
      const refUserRef = ref(db,"users/"+referredBy);
      const refUserSnap = await get(refUserRef);
      if(refUserSnap.exists()){
        const refUser = refUserSnap.val();
        const newBalance = (refUser.referralBalance || 0) + 6;
        await update(refUserRef,{ referralBalance:newBalance });
      }
    }

    showToast("Account created successfully");
    setTimeout(()=>location.href="dashboard.html",1200);

  }catch(e){
    if(e.code === "auth/email-already-in-use"){ showToast("Email already in use", false); }
    else if(e.code === "auth/invalid-email"){ showToast("Invalid email address", false); }
    else if(e.code === "auth/weak-password"){ showToast("Password is too weak", false); }
    else{ showToast(e.message,false); }
    console.error(e);
  }
};
</script>
</body>
  </html>
